<!DOCTYPE html>
<html lang="en" data-accent-color="lime" data-content_root="../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Developing Bots - silverback documentation</title><link rel="shortcut icon" href="../_static/favicon.ico"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Silverback Platform" href="managing.html" /><link rel="prev" title="Quick Start" href="quickstart.html" />
      <link rel="canonical" href="silverback/userguides/development.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../_static/shibuya.css?v=83eaa723" />
    <link media="print" rel="stylesheet" type="text/css" href="../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/>
<meta property="og:url" content="silverback/userguides/development.html"/>
<meta property="og:title" content="Developing Bots"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../index.html">
      <img class="light-logo" src="../_static/logo_grey.svg" alt="silverback" height="28" loading="lazy" />
      <img class="dark-logo" src="../_static/logo_green.svg" alt="silverback" height="28" loading="lazy" />
      <strong>silverback</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading" aria-level="3"><span class="caption-text">User Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developing Bots</a></li>
<li class="toctree-l1"><a class="reference internal" href="managing.html">Silverback Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploying.html">Deploying Bots</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">CLI Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../commands/run.html">Local Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/cluster.html">Cloud Platform</a></li>
</ul>
<p class="caption" role="heading" aria-level="3"><span class="caption-text">Python Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/exceptions.html">silverback.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/main.html">silverback.main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/middlewares.html">silverback.middlewares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/runner.html">silverback.runner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/subscriptions.html">silverback.subscriptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methoddocs/utils.html">silverback.utils</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div class="localtoc"><h3>On this page</h3><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#project-structure">Project structure</a></li>
<li><a class="reference internal" href="#creating-a-bot">Creating a Bot</a></li>
<li><a class="reference internal" href="#new-block-events">New Block Events</a></li>
<li><a class="reference internal" href="#new-event-logs">New Event Logs</a></li>
<li><a class="reference internal" href="#startup-and-shutdown">Startup and Shutdown</a><ul>
<li><a class="reference internal" href="#worker-events">Worker Events</a><ul>
<li><a class="reference internal" href="#worker-state">Worker State</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bot-events">Bot Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bot-state">Bot State</a><ul>
<li><a class="reference internal" href="#signing-transactions">Signing Transactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-your-bot">Running your Bot</a><ul>
<li><a class="reference internal" href="#distributed-execution">Distributed Execution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-your-bot">Testing your Bot</a></li>
<li><a class="reference internal" href="#deploying-your-bot">Deploying your Bot</a></li>
</ul>
</div><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6"><div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">silverback</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">Developing Bots</strong>
        <meta itemprop="position" content="2" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <section id="developing-bots">
<h1>Developing Bots<a class="headerlink" href="#developing-bots" title="Link to this heading"></a></h1>
<p>In this guide, we are going to show you more details on how to build an bot with Silverback.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h2>
<p>You should have a python project with Silverback installed.
You can install Silverback via <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">silverback</span></code></p>
</section>
<section id="project-structure">
<h2>Project structure<a class="headerlink" href="#project-structure" title="Link to this heading"></a></h2>
<p>There are 3 suggested ways to structure your project. In the root directory of your project:</p>
<ol class="arabic simple">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">bot.py</span></code> file. This is the simplest way to define your bot project.</p></li>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">bots/</span></code> folder. Then develop bots in this folder as separate scripts (Do not include a <strong>init</strong>.py file).</p></li>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">bot/</span></code> folder with a <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file that will include the instantiation of your <code class="docutils literal notranslate"><span class="pre">SilverbackBot()</span></code> object.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">silverback</span></code> cli automatically searches for python scripts to run as bots in specific locations relative to the root of your project.
It will also be able to detect the scripts inside your <code class="docutils literal notranslate"><span class="pre">bots/</span></code> directory and let you run those by name (in case you have multiple bots in your project).</p>
<p>If <code class="docutils literal notranslate"><span class="pre">silverback</span></code> finds a module named <code class="docutils literal notranslate"><span class="pre">bot</span></code> in the root directory of the project, then it will use that by default.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is suggested that you create the instance of your <code class="docutils literal notranslate"><span class="pre">SilverbackBot()</span></code> object by naming the variable <code class="docutils literal notranslate"><span class="pre">bot</span></code>, since <code class="docutils literal notranslate"><span class="pre">silverback</span></code> will autodetect that variable name when loading your script file.</p>
</div>
<p>Another way you can structure your bot is to create a <code class="docutils literal notranslate"><span class="pre">bot</span></code> folder and define a runner inside of that folder as <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>.</p>
<p>If you have a more complicated project that requires multiple bots, naming each bot their own individual name is okay to do, and we encourage you to locate them under the <code class="docutils literal notranslate"><span class="pre">bots/</span></code> folder relative to the root of your project.
This will work fairly seamlessly with the rest of the examples shown in this guide.</p>
<p>To run a bot, as long as your project directory follows the suggestions above by using a <code class="docutils literal notranslate"><span class="pre">bot</span></code> module, you can run it easily with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">silverback<span class="w"> </span>run<span class="w"> </span>--network<span class="w"> </span>your:network:of:choice
</span></pre></div>
</div>
<p>If your bot’s module name is <code class="docutils literal notranslate"><span class="pre">example.py</span></code> (for example), you can run it like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">silverback<span class="w"> </span>run<span class="w"> </span>example<span class="w"> </span>--network<span class="w"> </span>your:network:of:choice
</span></pre></div>
</div>
<p>If the variable that you call the <code class="docutils literal notranslate"><span class="pre">SilverbackBot()</span></code> object is something other than <code class="docutils literal notranslate"><span class="pre">bot</span></code>, you can specific that by adding <code class="docutils literal notranslate"><span class="pre">:{variable-name}</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">silverback<span class="w"> </span>run<span class="w"> </span>example:my_bot<span class="w"> </span>--network<span class="w"> </span>your:network:of:choice
</span></pre></div>
</div>
<p>We will automatically detect all scripts under the <code class="docutils literal notranslate"><span class="pre">bots/</span></code> folder automatically, but if your bot resides in a location other than <code class="docutils literal notranslate"><span class="pre">bots/</span></code> then you can use this to run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">silverback<span class="w"> </span>run<span class="w"> </span>folder.example:bot<span class="w"> </span>--network<span class="w"> </span>your:network:of:choice
</span></pre></div>
</div>
<p>Note that with a <code class="docutils literal notranslate"><span class="pre">bot/__init__.py</span></code> setup, silverback will also autodetect it, and you can run it with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1">silverback<span class="w"> </span>run<span class="w"> </span>--network<span class="w"> </span>your:network:of:choice
</span></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is suggested that you develop your bots as scripts to keep your deployments simple.
If you have a deep understanding of containerization, and have specific needs, you can set your bots up however you’d like, and then create your own container definitions for deployments to publish to your reqistry of choice.
For the most streamlined experience, develop your bots as scripts, and avoid relying on local packages
(e.g. do not include an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file inside your <code class="docutils literal notranslate"><span class="pre">bots/</span></code> directory, and do not use local modules inside <code class="docutils literal notranslate"><span class="pre">bots/</span></code> for reusable code).
If you follow these suggestions, your Silverback deployments will be easy to use and require almost no thought.</p>
</div>
</section>
<section id="creating-a-bot">
<h2>Creating a Bot<a class="headerlink" href="#creating-a-bot" title="Link to this heading"></a></h2>
<p>Creating a Silverback Bot is easy, to do so initialize the <code class="docutils literal notranslate"><span class="pre">silverback.SilverbackBot</span></code> class:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span> <span class="nn">silverback</span> <span class="kn">import</span> <span class="n">SilverbackBot</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">bot</span> <span class="o">=</span> <span class="n">SilverbackBot</span><span class="p">()</span>
</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SilverbackBot</span></code> class handles state and configuration.
Through this class, we can hook up event handlers to be executed each time we encounter a new block or each time a specific event is emitted.
Initializing the bot creates a network connection using the Ape configuration of your local project, making it easy to add a Silverback bot to your project in order to perform automation of necessary on-chain interactions required.</p>
<p>However, by default an bot has no configured event handlers, so it won’t be very useful.
This is where adding event handlers is useful via the <code class="docutils literal notranslate"><span class="pre">bot.on_</span></code> method.
This method lets us specify which event will trigger the execution of our handler as well as which handler to execute.</p>
</section>
<section id="new-block-events">
<h2>New Block Events<a class="headerlink" href="#new-block-events" title="Link to this heading"></a></h2>
<p>To add a block handler, you will do the following:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span> <span class="nn">ape</span> <span class="kn">import</span> <span class="n">chain</span>
</span><span data-line="2">
</span><span data-line="3"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
</span><span data-line="4"><span class="k">def</span> <span class="nf">handle_new_block</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span><span data-line="5">    <span class="o">...</span>
</span></pre></div>
</div>
<p>Inside of <code class="docutils literal notranslate"><span class="pre">handle_new_block</span></code> you can define any logic that you want to handle each new <code class="docutils literal notranslate"><span class="pre">block</span></code> detected by the silverback client.
You can return any serializable data structure from this function and that will be stored in the results database as a trackable metric for the execution of this handler.
Any errors you raise during this function will get captured by the client, and recorded as a failure to handle this <code class="docutils literal notranslate"><span class="pre">block</span></code>.</p>
</section>
<section id="new-event-logs">
<h2>New Event Logs<a class="headerlink" href="#new-event-logs" title="Link to this heading"></a></h2>
<p>Similarly to blocks, you can handle events emitted by a contract by adding an event handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span> <span class="nn">ape</span> <span class="kn">import</span> <span class="n">Contract</span>
</span><span data-line="2">
</span><span data-line="3"><span class="n">TOKEN</span> <span class="o">=</span> <span class="n">Contract</span><span class="p">(</span><span class="o">&lt;</span><span class="n">your</span> <span class="n">token</span> <span class="n">address</span> <span class="n">here</span><span class="o">&gt;</span><span class="p">)</span>
</span><span data-line="4">
</span><span data-line="5"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_</span><span class="p">(</span><span class="n">TOKEN</span><span class="o">.</span><span class="n">Transfer</span><span class="p">)</span>
</span><span data-line="6"><span class="k">def</span> <span class="nf">handle_token_transfer_events</span><span class="p">(</span><span class="n">transfer</span><span class="p">):</span>
</span><span data-line="7">    <span class="o">...</span>
</span></pre></div>
</div>
<p>Inside of <code class="docutils literal notranslate"><span class="pre">handle_token_transfer_events</span></code> you can define any logic that you want to handle each new <code class="docutils literal notranslate"><span class="pre">transfer</span></code> event that gets emitted by <code class="docutils literal notranslate"><span class="pre">TOKEN.Transfer</span></code> detected by the silverback client.
Again, you can return any serializable data structure from this function and that will be stored in the results database as a trackable metric for the execution of this handler.
Any errors you raise during this function will get captured by the client, and recorded as a failure to handle this <code class="docutils literal notranslate"><span class="pre">transfer</span></code> event log.</p>
</section>
<section id="startup-and-shutdown">
<h2>Startup and Shutdown<a class="headerlink" href="#startup-and-shutdown" title="Link to this heading"></a></h2>
<section id="worker-events">
<h3>Worker Events<a class="headerlink" href="#worker-events" title="Link to this heading"></a></h3>
<p>If you have heavier resources you want to load during startup, or want to initialize things like database connections, you can add a worker startup function like so:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_worker_startup</span><span class="p">()</span>
</span><span data-line="2"><span class="k">def</span> <span class="nf">handle_on_worker_startup</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span data-line="3">    <span class="c1"># Connect to DB, set initial state, etc</span>
</span><span data-line="4">    <span class="o">...</span>
</span><span data-line="5">
</span><span data-line="6"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_worker_shutdown</span><span class="p">()</span>
</span><span data-line="7"><span class="k">def</span> <span class="nf">handle_on_worker_shutdown</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span data-line="8">    <span class="c1"># cleanup resources, close connections cleanly, etc</span>
</span><span data-line="9">    <span class="o">...</span>
</span></pre></div>
</div>
<p>This function comes a parameter <code class="docutils literal notranslate"><span class="pre">state</span></code> that you can use for storing the results of your startup computation or resources that you have provisioned.</p>
<p>It’s import to note that this is useful for ensuring that your workers (of which there can be multiple) have the resources necessary to properly handle any updates you want to make in your handler functions, such as connecting to the Telegram API, an SQL or NoSQL database connection, or something else.  <strong>This function will run on every worker process</strong>.</p>
<p><em>New in 0.2.0</em>: These events moved from <code class="docutils literal notranslate"><span class="pre">on_startup()</span></code> and <code class="docutils literal notranslate"><span class="pre">on_shutdown()</span></code> for clarity.</p>
<section id="worker-state">
<h4>Worker State<a class="headerlink" href="#worker-state" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">state</span></code> variable is also useful as this can be made available to each handler method so other stateful quantities can be maintained for other uses.  Each distributed worker has its own instance of state.</p>
<p>To access the state from a handler, you must annotate <code class="docutils literal notranslate"><span class="pre">context</span></code> as a dependency like so:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Annotated</span>
</span><span data-line="2"><span class="kn">from</span> <span class="nn">taskiq</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">TaskiqDepends</span>
</span><span data-line="3">
</span><span data-line="4"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
</span><span data-line="5"><span class="k">def</span> <span class="nf">block_handler</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Context</span><span class="p">,</span> <span class="n">TaskiqDepends</span><span class="p">()]):</span>
</span><span data-line="6">    <span class="c1"># Access state via context.state</span>
</span><span data-line="7">    <span class="o">...</span>
</span></pre></div>
</div>
</section>
</section>
<section id="bot-events">
<h3>Bot Events<a class="headerlink" href="#bot-events" title="Link to this heading"></a></h3>
<p>You can also add an bot startup and shutdown handler that will be <strong>executed once upon every bot startup</strong>.  This may be useful for things like processing historical events since the bot was shutdown or other one-time actions to perform at startup.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_startup</span><span class="p">()</span>
</span><span data-line="2"><span class="k">def</span> <span class="nf">handle_on_startup</span><span class="p">(</span><span class="n">startup_state</span><span class="p">):</span>
</span><span data-line="3">    <span class="c1"># Process missed events, etc</span>
</span><span data-line="4">    <span class="c1"># process_history(start_block=startup_state.last_block_seen)</span>
</span><span data-line="5">    <span class="c1"># ...or startup_state.last_block_processed</span>
</span><span data-line="6">    <span class="o">...</span>
</span><span data-line="7">
</span><span data-line="8">
</span><span data-line="9"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">()</span>
</span><span data-line="10"><span class="k">def</span> <span class="nf">handle_on_shutdown</span><span class="p">():</span>
</span><span data-line="11">    <span class="c1"># Record final state, etc</span>
</span><span data-line="12">    <span class="o">...</span>
</span></pre></div>
</div>
<p><em>Changed in 0.2.0</em>: The behavior of the <code class="docutils literal notranslate"><span class="pre">&#64;bot.on_startup()</span></code> decorator and handler signature have changed.  It is now executed only once upon bot startup and worker events have moved on <code class="docutils literal notranslate"><span class="pre">&#64;bot.on_worker_startup()</span></code>.</p>
</section>
</section>
<section id="bot-state">
<h2>Bot State<a class="headerlink" href="#bot-state" title="Link to this heading"></a></h2>
<p>Sometimes it is very useful to have access to values in a shared state across your workers.
For example you might have a value or complex reference type that you wish to update during one of your tasks, and read during another.
Silverback provides <code class="docutils literal notranslate"><span class="pre">bot.state</span></code> to help with these use cases.</p>
<p>For example, you might want to pre-populate a large dataframe into state on startup, keeping that dataframe in sync with the chain through event logs,
and then use that data to determine a signal under which you want trigger transactions to commit back to the chain.
Such an bot might look like this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_startup</span><span class="p">()</span>
</span><span data-line="2"><span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">startup_state</span><span class="p">):</span>
</span><span data-line="3">    <span class="n">df</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">MyEvent</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">start_block</span><span class="o">=</span><span class="n">startup_state</span><span class="o">.</span><span class="n">last_block_processed</span><span class="p">)</span>
</span><span data-line="4">    <span class="o">...</span>  <span class="c1"># Do some further processing on df</span>
</span><span data-line="5">    <span class="n">bot</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">df</span>
</span><span data-line="6">
</span><span data-line="7">
</span><span data-line="8"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_</span><span class="p">(</span><span class="n">contract</span><span class="o">.</span><span class="n">MyEvent</span><span class="p">)</span>
</span><span data-line="9"><span class="k">def</span> <span class="nf">update_table</span><span class="p">(</span><span class="n">log</span><span class="p">):</span>
</span><span data-line="10">    <span class="n">bot</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># Update using stuff from `log`</span>
</span><span data-line="11">
</span><span data-line="12">
</span><span data-line="13"><span class="nd">@bot</span><span class="o">.</span><span class="n">on_</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">blocks</span><span class="p">)</span>
</span><span data-line="14"><span class="k">def</span> <span class="nf">use_table</span><span class="p">(</span><span class="n">blk</span><span class="p">):</span>
</span><span data-line="15">    <span class="k">if</span> <span class="n">bot</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">bot</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
</span><span data-line="16">        <span class="c1"># Trigger your bot to send a transaction from `bot.signer`</span>
</span><span data-line="17">        <span class="n">contract</span><span class="o">.</span><span class="n">myMethod</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">bot</span><span class="o">.</span><span class="n">signer</span><span class="p">)</span>
</span><span data-line="18">    <span class="o">...</span>
</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">bot.state</span></code> to store any python variable type, however note that the item is not networked nor threadsafe so it is not recommended to have multiple tasks write to the same value in state at the same time.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Bot startup and bot runtime event triggers (e.g. block or event container) are handled distinctly and can be trusted not to execute at the same time.</p>
</div>
<section id="signing-transactions">
<h3>Signing Transactions<a class="headerlink" href="#signing-transactions" title="Link to this heading"></a></h3>
<p>If configured, your bot with have <code class="docutils literal notranslate"><span class="pre">bot.signer</span></code> which is an Ape account that can sign arbitrary transactions you ask it to.
To learn more about signing transactions with Ape, see the <a class="reference external" href="https://docs.apeworx.io/ape/stable/userguides/transactions.html">documentation</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While not recommended, you can use keyfile accounts for automated signing.
See <a class="reference external" href="https://docs.apeworx.io/ape/stable/userguides/accounts.html#automation">this guide</a> to learn more about how to do that.</p>
</div>
</section>
</section>
<section id="running-your-bot">
<h2>Running your Bot<a class="headerlink" href="#running-your-bot" title="Link to this heading"></a></h2>
<p>Once you have programmed your bot, it’s really useful to be able to run it locally and validate that it does what you expect it to do.
To run your bot locally, we have included a really useful cli command <a class="reference external" href="../commands/run"><code class="docutils literal notranslate"><span class="pre">run</span></code></a> that takes care of connecting to the proper network, configuring signers (using your local Ape accounts), and starting up the bot client and in-memory task queue workers.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Run your bot on the Ethereum Sepolia testnet, with your own signer:</span>
</span><span data-line="2">$<span class="w"> </span>silverback<span class="w"> </span>run<span class="w"> </span>my_bot<span class="w"> </span>--network<span class="w"> </span>:sepolia<span class="w"> </span>--account<span class="w"> </span>acct-name
</span></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">my_bot:bot</span></code> is not required for silverback run if you follow the suggested folder structure at the start of this page, you can just call it via <code class="docutils literal notranslate"><span class="pre">my_bot</span></code>.</p>
</div>
<p>It’s important to note that signers are optional, if not configured in the bot then <code class="docutils literal notranslate"><span class="pre">bot.signer</span></code> will be <code class="docutils literal notranslate"><span class="pre">None</span></code>.
You can use this in your bot to enable a “test execution” mode, something like this:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="c1"># Compute some metric that might lead to creating a transaction</span>
</span><span data-line="2"><span class="k">if</span> <span class="n">bot</span><span class="o">.</span><span class="n">signer</span><span class="p">:</span>
</span><span data-line="3">    <span class="c1"># Execute a transaction via `sender=bot.signer`</span>
</span><span data-line="4"><span class="k">else</span><span class="p">:</span>
</span><span data-line="5">    <span class="c1"># Log what the transaction *would* have done, had a signer been enabled</span>
</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you configure your bot to use a signer, and that signer signs anything given to it, remember that you can lose substational amounts of funds if you deploy this to a production network.
Always test your bots throughly before deploying, and always use a dedicated key for production signing with your bot in a remote setting.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is highly suggested to use a dedicated cloud signer plugin, such as <a class="reference external" href="https://github.com/ApeWorX/ape-aws"><code class="docutils literal notranslate"><span class="pre">ape-aws</span></code></a> for signing transactions in a cloud environment.
Use segregated keys and limit your risk by controlling the amount of funds that key has access to at any given time.</p>
</div>
<section id="distributed-execution">
<h3>Distributed Execution<a class="headerlink" href="#distributed-execution" title="Link to this heading"></a></h3>
<p>Using only the <code class="docutils literal notranslate"><span class="pre">silverback</span> <span class="pre">run</span> <span class="pre">...</span></code> command in a default configuration executes everything in one process and the job queue is completely in-memory with a shared state.
In some high volume environments, you may want to deploy your Silverback bot in a distributed configuration using multiple processes to handle the messages at a higher rate.</p>
<p>The primary components are the client and workers.  The client handles Silverback events (blocks and contract event logs) and creates jobs for the workers to process in an asynchronous manner.</p>
<p>For this to work, you must configure a <a class="reference external" href="https://taskiq-python.github.io/guide/architecture-overview.html#broker">TaskIQ broker</a> capable of distributed processing.
Additonally, it is highly suggested you should also configure a <a class="reference external" href="https://taskiq-python.github.io/guide/architecture-overview.html#result-backend">TaskIQ result backend</a> in order to process and store the results of executing tasks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Without configuring a result backend, Silverback may not work as expected since your tasks will now suddenly return <code class="docutils literal notranslate"><span class="pre">None</span></code> instead of the actual result.</p>
</div>
<p>For instance, with <a class="reference external" href="https://github.com/taskiq-python/taskiq-redis"><code class="docutils literal notranslate"><span class="pre">taskiq_redis</span></code></a> you could do something like this for the client:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_BROKER_CLASS</span><span class="o">=</span><span class="s2">&quot;taskiq_redis:ListQueueBroker&quot;</span>
</span><span data-line="2"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_BROKER_KWARGS</span><span class="o">=</span><span class="s1">&#39;{&quot;queue_name&quot;: &quot;taskiq&quot;, &quot;url&quot;: &quot;redis://127.0.0.1:6379&quot;}&#39;</span>
</span><span data-line="3"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_RESULT_BACKEND_CLASS</span><span class="o">=</span><span class="s2">&quot;taskiq_redis:RedisAsyncResultBackend&quot;</span>
</span><span data-line="4"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_RESULT_BACKEND_URI</span><span class="o">=</span><span class="s2">&quot;redis://127.0.0.1:6379&quot;</span>
</span><span data-line="5">
</span><span data-line="6">silverback<span class="w"> </span>run<span class="w"> </span>--network<span class="w"> </span>:mainnet:alchemy
</span></pre></div>
</div>
<p>And then the worker process with 2 worker subprocesses:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span data-line="1"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_BROKER_CLASS</span><span class="o">=</span><span class="s2">&quot;taskiq_redis:ListQueueBroker&quot;</span>
</span><span data-line="2"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_BROKER_KWARGS</span><span class="o">=</span><span class="s1">&#39;{&quot;url&quot;: &quot;redis://127.0.0.1:6379&quot;}&#39;</span>
</span><span data-line="3"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_RESULT_BACKEND_CLASS</span><span class="o">=</span><span class="s2">&quot;taskiq_redis:RedisAsyncResultBackend&quot;</span>
</span><span data-line="4"><span class="nb">export</span><span class="w"> </span><span class="nv">SILVERBACK_RESULT_BACKEND_URI</span><span class="o">=</span><span class="s2">&quot;redis://127.0.0.1:6379&quot;</span>
</span><span data-line="5">
</span><span data-line="6">silverback<span class="w"> </span>worker<span class="w"> </span>-w<span class="w"> </span><span class="m">2</span>
</span></pre></div>
</div>
<p>The client will send tasks to the 2 worker subprocesses, and all task queue and results data will be go through Redis.</p>
</section>
</section>
<section id="testing-your-bot">
<h2>Testing your Bot<a class="headerlink" href="#testing-your-bot" title="Link to this heading"></a></h2>
<p>TODO: Add backtesting mode w/ <code class="docutils literal notranslate"><span class="pre">silverback</span> <span class="pre">test</span></code></p>
</section>
<section id="deploying-your-bot">
<h2>Deploying your Bot<a class="headerlink" href="#deploying-your-bot" title="Link to this heading"></a></h2>
<p>Check out the <a class="reference external" href="./platform.html">Platform Deployment Userguide</a> for more information on how to deploy your bot to the <a class="reference external" href="https://silverback.apeworx.io">Silverback Platform</a>.</p>
</section>
</section>

        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"><div class="navigation-prev">
    <a href="quickstart.html">
      <i class="i-lucide chevron-left"></i>
      <div class="page-info">
        <span>Previous</span><div class="title">Quick Start</div></div>
    </a>
  </div><div class="navigation-next">
    <a href="managing.html">
      <div class="page-info">
        <span>Next</span>
        <div class="title">Silverback Platform</div>
      </div>
      <i class="i-lucide chevron-right"></i>
    </a>
  </div></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, ApeWorX LTD</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script data-domain="docs.apeworx.io" defer="defer" src="https://plausible.io/js/script.js"></script>
      <script src="../_static/shibuya.js?v=e2e99575"></script></body>
</html>